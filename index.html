<!DOCTYPE html>
<html>
<head>
    <title>マピオンベクター</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel='stylesheet' href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.css' />
    <style>
        body { margin: 0; padding: 0; }
        html, body { height: 100%; }
        #map { position:absolute; top:0; bottom:0; width:100%; }

        @media screen and (min-width: 0px) and (max-device-width: 930px) {
            .logo {
                position: absolute;
                left: 0;
                bottom: 20px;
                margin: auto;
                width: 83px;
                height: 30px;
            }
        }

        @media screen and (min-device-width: 931px) {
            .logo {
                position: absolute;
                left: 0;
                right: 0;
                bottom: 0;
                margin: auto;
                width: 83px;
                height: 30px;
            }
        }

        .kyorisoku {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            width: 80px;
            top: 0;
            left: 0;
            padding: 10px;
        }
        .kyorisoku .kyorisoku-inner {
            background-color: rgba(255, 255, 255, 1);
            border-radius: 5px;
            padding: 2px;
            margin-bottom: 10px;
            box-shadow:0 0 0 2px rgba(0,0,0,0.1);
        }
        .kyorisoku input, label {
            cursor:pointer;
        }

        @media screen and (min-width: 0px) and (max-device-width: 930px) {
            .maptype {
                font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
                position: absolute;
                background-color: rgba(255,255,255,1);
                margin:10px 0 0;
                border-radius:13px;
                vertical-align:middle;
                top: 35px;
                left: 10px;
                padding: 2px;
                width: 280px;
                box-shadow:0 0 0 2px rgba(0,0,0,0.1);
            }
        }

        @media screen and (min-device-width: 931px) {
            .maptype {
                font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
                position: absolute;
                background-color: rgba(255,255,255,1);
                margin:10px 0 0;
                border-radius:13px;
                vertical-align:middle;
                top: 0;
                right: 50px;
                padding: 2px;
                width: 280px;
                box-shadow:0 0 0 2px rgba(0,0,0,0.1);
            }
        }
        .maptype label {
            cursor:pointer;
            vertical-align:top;
            display:block;
            border-radius:13px;
            padding:0 0;

            color:rgba(0,0,0,.5);
            line-height:20px;
            text-align:center;
            width:33%;
            float:left;
        }
        .maptype label:hover {
            color:rgba(0,0,0,.75);
        }
        .maptype input[type=radio] {
            display:none;
        }
        .maptype input[type=radio]:checked + label:hover,
        .maptype input[type=radio]:checked + label {
            background:#eee;
            color:rgba(0,0,0,.75);
        }

        .help {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            width: 160px;
            bottom: 0;
            padding: 0 5px;
            background-color: rgba(255,255,255,0.5);
            margin: 0;
        }

        .help a {
            color: rgba(0,0,0,0.75);
            text-decoration: none;
        }
        .help a:hover {
            color: inherit;
            text-decoration: underline;
        }

    </style>
</head>

<body>
<div id='map'></div>
<div class='logo'>
    <a href='//www.mapion.co.jp/'><img src='mapion@2x.png' width='83' height='30'></a>
</div>
<div class='kyorisoku'>
    <div class='kyorisoku-inner'>
        <input id='kyorisoku_label' type='checkbox' name='rtoggle'>
        <label for='kyorisoku_label'>距離測定</label>
    </div>
</div>
<div class="maptype">
    <input id="lab" type="radio" name="profile">
    <label for="lab">ラボ地図</label>
    <input id="mono" type="radio" name="profile">
    <label for="mono">モノトーン地図</label>
    <input id="osm-direct" type="radio" name="profile">
    <label for="osm-direct">OSM地図</label>
</div>
<div class='help'>
<a href='./help.html'>HELP</a>&nbsp;|&nbsp;<a href='https://form.jotform.me/62729205497464' target='_blank'>フィードバックの送信</a>
</div>

<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.js'></script>
<script src='https://api.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>
<script>

function parsePramameter(results) {
    var pair=location.search.substring(1).split('&');
    for (var i=0; pair[i]; i++) {
        var kv = pair[i].split('=');
        results[kv[0]]=kv[1];
    }
}

function getAbsolutePath(name) {
    // return 'https://vt01.mapion.co.jp/gl-server/style/' + name + '.json?access_token=mt-pk.eyJ1IjoibWFwaW9uIiwiYSI6InJ5ZXFiOWJyZ3J2MjV3ZDcyNXY3Z3dmYzYifQ.XoOA7fe-5nUi8ALSyCl277';

    switch (name) {
    case 'lab':
        return 'https://vt-stg.mapion.co.jp/mvt-styler/projects/65/style.json';
    case 'mono':
        return 'https://vt-stg.mapion.co.jp/mvt-styler/projects/64/style.json';
    default:
        return 'https://vt01.mapion.co.jp/gl-server/style/' + name + '.json?access_token=mt-pk.eyJ1IjoibWFwaW9uIiwiYSI6InJ5ZXFiOWJyZ3J2MjV3ZDcyNXY3Z3dmYzYifQ.XoOA7fe-5nUi8ALSyCl277';
    }
}

function initKyorisoku() {
    distanceFeatures = {
        "type": "FeatureCollection",
        "features": []
    };

    map.addSource('geojson', {
        "type": "geojson",
        "data": distanceFeatures
    });

    map.addLayer({
        id: 'measure-points',
        type: 'circle',
        source: 'geojson',
        paint: {
            'circle-radius': 5,
            'circle-color': '#000'
        },
        filter: ['in', '$type', 'Point']
    });

    map.addLayer({
        id: 'measure-lines',
        type: 'line',
        source: 'geojson',
        layout: {
          'line-cap': 'round',
          'line-join': 'round'
        },
        paint: {
          'line-color': '#000',
          'line-width': 2.5
        },
        filter: ['in', '$type', 'LineString']
    });
}

function destroyKyorisoku() {
    if (distancePopup) {
        distancePopup.remove();
        distancePopup = null;
    }

    if (kyorisokuMode) {
        map.removeLayer('measure-lines');
        map.removeLayer('measure-points');
        map.removeSource('geojson');
    }
}

function resetCheckbox() {
    destroyKyorisoku();
    document.getElementById('kyorisoku_label').checked = false;
    kyorisokuMode = false;
}

var params = {};
parsePramameter(params);

var style = params.style ? params.style : 'lab'; // /mapion-vector/?style=base
document.getElementById(style).checked = true;

var PRODUCT = document.domain === 'mapion.github.io' ? true : false;

var map; // for external use

if (!mapboxgl.supported()) {
    alert('Your browser does not support Mapion GL');
}

map = new mapboxgl.Map({
    container: 'map',
    center: [139.749792, 35.641690],
    zoom: 16,
    minZoom: 5,
    maxZoom: 19,
    style: getAbsolutePath(style),
    hash: true
});

map.addControl(new mapboxgl.NavigationControl());
map.addControl(new mapboxgl.GeolocateControl());
map.addControl(new mapboxgl.FullscreenControl());
map.addControl(new mapboxgl.ScaleControl(), 'bottom-right');

/*
% webmerc -o 5/25/15
5.615985,106.874999
% webmerc -o 5/30/10
52.48278,163.124999
*/

// map.setMaxBounds(new mapboxgl.LngLatBounds([106.874999, 5.615985], [163.124999, 52.48278]));
// map.showTileBoundaries = PRODUCT?false:true;

map.on('load', function() {

    map.on('click', function(e) {
        if (!kyorisokuMode) return;

        var features = map.queryRenderedFeatures(e.point, { layers: ['measure-points'] });

        if (distanceFeatures.features.length > 1) distanceFeatures.features.pop();

        if (features.length) {
            var id = features[0].properties.id;
            distanceFeatures.features = distanceFeatures.features.filter(function(point) {
                return point.properties.id !== id;
            });
            if (features.length <= 1) {
                if (distancePopup) {
                    distancePopup.remove();
                    distancePopup = null;
                }
            }
        } else {
            var point = {
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [
                        e.lngLat.lng,
                        e.lngLat.lat
                    ]
                },
                "properties": {
                    "id": String(new Date().getTime())
                }
            };

            distanceFeatures.features.push(point);
        }

        if (distanceFeatures.features.length > 1) {
            linestring.geometry.coordinates = distanceFeatures.features.map(function(point) {
                return point.geometry.coordinates;
            });

            distanceFeatures.features.push(linestring);

            var c = distanceFeatures.features[distanceFeatures.features.length-2].geometry.coordinates;
            if (distancePopup === null) {
                distancePopup = new mapboxgl.Popup({closeButton: false, closeOnClick: false}).addTo(map);
            }
            distancePopup.setLngLat(c).setHTML(Math.round(turf.lineDistance(linestring).toLocaleString() * 1000) / 1000 + 'km');
        }

        map.getSource('geojson').setData(distanceFeatures);

    });

    map.on('click', 'middle_annotation 文字とアイコン', function (e) {
        poiOnClick(e, e.features[0].properties.name_string1);
    });
    map.on('click', 'base_annotation 文字とアイコン', function (e) {
        poiOnClick(e, e.features[0].properties.name_string1);
    });
    map.on('click', 'city_annotation 文字とアイコン', function (e) {
        poiOnClick(e, e.features[0].properties.name_string1);
    });
    map.on('click', 'ロゴ', function (e) {
        poiOnClick(e, e.features[0].properties.poi_name);
    });
    map.on('click', 'ロゴ（名称）', function (e) {
        poiOnClick(e, e.features[0].properties.poi_name);
    });
});

map.on('mousemove', function (e) {
    if (kyorisokuMode) {
        var features = map.queryRenderedFeatures(e.point, { layers: ['measure-points'] });
        map.getCanvas().style.cursor = (features.length) ? 'default' : 'crosshair';
    } else {
        map.getCanvas().style.cursor = 'default';
    }
});

function poiOnClick(e, name) {
    if (!kyorisokuMode && name) {
        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(name)
            .addTo(map);
    }
}

function changeMap() {
    return function(e) {
        resetCheckbox();
        map.setStyle(getAbsolutePath(e.target.id));
    }
}
document.getElementById('lab').onclick = changeMap();
document.getElementById('mono').onclick = changeMap();
document.getElementById('osm-direct').onclick = changeMap();

var kyorisokuMode = false;
document.getElementById('kyorisoku_label').onclick = function(e) {
    e.target.checked ? initKyorisoku() : destroyKyorisoku();
    kyorisokuMode = e.target.checked;
};

var distancePopup = null;
var distanceFeatures;

var linestring = {
    "type": "Feature",
    "geometry": {
        "type": "LineString",
        "coordinates": []
    }
};

// GA
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', PRODUCT?'UA-29986121-1':'UA-82138036-1', 'auto');
ga('send', 'pageview');

</script>
</body>
</html>
