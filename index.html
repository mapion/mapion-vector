<!DOCTYPE html>
<html>
<head>
    <title>マピオンベクター</title>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=EDGE" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel='stylesheet' href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' />
    <style>
        body { margin: 0; padding: 0; }
        html, body { height: 100%; }
        #map { position:absolute; top:0; bottom:0; width:100%; }

        .map-layer {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            width: 200px;
            top: 0;
            left: 0;
            padding: 10px;
        }

        .map-layer .map-layer-inner {
            background-color: #fff;
            border-radius: 5px;
            padding: 8px;
            margin-bottom: 10px;
            box-shadow:0 0 0 2px rgba(0,0,0,0.1);
        }

        .map-layer-inner fieldset {
            border: none;
            padding: 0;
            margin: 0 0 10px;
        }

        .map-layer-inner fieldset:last-child {
            margin: 0;
        }

        .map-layer-inner select {
            width: 100%;
        }

        .map-layer-inner label {
            display: block;
            font-weight: bold;
            margin: 0 0 5px;
        }

        .kyorisoku {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            width: 80px;
            top: 0;
            right: 150px;
            padding: 10px;
        }
        .kyorisoku .kyorisoku-inner {
            background-color: rgba(255, 255, 255, 1);
            border-radius: 5px;
            padding: 2px;
            margin-bottom: 10px;
            box-shadow:0 0 0 2px rgba(0,0,0,0.1);
        }
        .kyorisoku input, label {
            cursor:pointer;
            font-weight: bold;
        }

        .earthquake {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            width: 100px;
            top: 0;
            right: 40px;
            padding: 10px;
        }

        .earthquake .earthquake-inner {
            background-color: #fff;
            border-radius: 5px;
            padding: 5px;
            margin-bottom: 10px;
            box-shadow:0 0 0 2px rgba(0,0,0,0.1);
        }

        .earthquake-inner fieldset {
            border: none;
            padding: 0;
            margin: 0 0 10px;
        }

        .earthquake-inner fieldset:last-child {
            margin: 0;
        }

        .earthquake-inner select {
            width: 100%;
        }

        .earthquake-inner label {
            display: block;
            font-weight: bold;
            margin: 0 0 5px;
        }

        .help {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            width: 30px;
            bottom: 0;
            padding: 0 5px;
            background-color: rgba(255,255,255,0.5);
            margin: 0;
        }

        .help a {
            color: rgba(0,0,0,0.75);
            text-decoration: none;
        }
        .help a:hover {
            color: inherit;
            text-decoration: underline;
        }

        #init {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            right: 250px;
            top: 10px;
            border: 0;
            cursor: pointer;
            color:#fff;
            background-color: rgb(64,135,200);
            border-radius:5px;
        }

    </style>
</head>

<body>
<div id='map'></div>
<div class='map-layer top'>
    <div class='map-layer-inner'>
        <fieldset>
            <label>地図を選択</label>
            <select id='layer' name='layer' onchange='onlayer(this)'>
                <option value='lab'>ラボ地図</option>
                <option value='with-en'>ラボ地図（with英語）</option>
                <option value='mono'>モノトーン地図</option>
                <option value='osm'>OSM地図</option>
            </select>
        </fieldset>
        <fieldset id='lang-field'>
            <label>言語を選択</label>
            <select id='change-lang' name='change-lang' onchange='switchLanguage(this)'>
                <option value='lang'>日本語</option>
                <option value='lang_en'>英語</option>
                <option value='lang_cn'>中国語（簡体字）</option>
                <option value='lang_tw'>中国語（繁体字）</option>
                <option value='lang_ko'>韓国語</option>
            </select>
        </fieldset>
    </div>
</div>
<div class='mapboxgl-ctrlaaa'>
    <button id='init'>初期位置に戻る</button>
</div>
<div class='kyorisoku'>
    <div class='kyorisoku-inner'>
        <input id='kyorisoku_label' type='checkbox' name='rtoggle'>
        <label for='kyorisoku_label'>距離測定</label>
    </div>
</div>
<div class='earthquake top'>
    <div class='earthquake-inner'>
        <fieldset>
            <label>過去の地震</label>
            <select id='past' name='past' onchange='onEarthquake(this)'>
                <option value='default'>非表示</option>
                <option value='all_hour'>過去1時間</option>
                <option value='all_day'>過去1日</option>
                <option value='all_week'>過去7日</option>
                <option value='all_month'>過去30日</option>
            </select>
        </fieldset>
    </div>
</div>
<div class='help'>
<a href='./help.html'>HELP</a>
</div>

<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
<script src='https://api.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>
<script>
var accessToken = 'mt-pk.eyJ1IjoibWFwaW9uIiwiYSI6InJ5ZXFiOWJyZ3J2MjV3ZDcyNXY3Z3dmYzYifQ.XoOA7fe-5nUi8ALSyCl277';

function parsePramameter(results) {
    var pair=location.search.substring(1).split('&');
    for (var i=0; pair[i]; i++) {
        var kv = pair[i].split('=');
        results[kv[0]]=kv[1];
    }
}

function getAbsolutePath(name) {
    switch (name) {
    case 'lab':
        return 'https://vt-stg.mapion.co.jp/gl-server/style/lab.json?access_token=' + accessToken;
    case 'with-en':
        return 'https://vt-stg.mapion.co.jp/gl-server/style/glmaps.json?access_token=' + accessToken;
    case 'mono':
        return 'https://vt-stg.mapion.co.jp/gl-server/style/mono.json?access_token=' + accessToken;
    case 'osm':
        return 'https://vt-stg.mapion.co.jp/gl-server/style/osm-direct.json?access_token=' + accessToken;
    default:
        return 'https://vt01.mapion.co.jp/gl-server/style/' + name + '.json?access_token=' + accessToken;
    }
}

function initKyorisoku() {
    distanceFeatures = {
        "type": "FeatureCollection",
        "features": []
    };

    map.addSource('geojson', {
        "type": "geojson",
        "data": distanceFeatures
    });

    map.addLayer({
        id: 'measure-points',
        type: 'circle',
        source: 'geojson',
        paint: {
            'circle-radius': 5,
            'circle-color': '#000'
        },
        filter: ['in', '$type', 'Point']
    });

    map.addLayer({
        id: 'measure-lines',
        type: 'line',
        source: 'geojson',
        layout: {
          'line-cap': 'round',
          'line-join': 'round'
        },
        paint: {
          'line-color': '#000',
          'line-width': 2.5
        },
        filter: ['in', '$type', 'LineString']
    });
}

function destroyKyorisoku() {
    if (distancePopup) {
        distancePopup.remove();
        distancePopup = null;
    }

    if (kyorisokuMode) {
        map.removeLayer('measure-lines');
        map.removeLayer('measure-points');
        map.removeSource('geojson');
    }
}

function resetCheckbox() {
    destroyKyorisoku();
    document.getElementById('kyorisoku_label').checked = false;
    kyorisokuMode = false;
}

function onlayer(select) {
    var langField = document.getElementById('lang-field');
    if (select.value === 'lab') {
        document.getElementById('change-lang').value = 'lang';
        langField.style.display = 'block';
    } else {
        langField.style.display = 'none';
    }

    resetCheckbox();
    map.setStyle(getAbsolutePath(select.value));
}

function onEarthquake(select) {
    var geojsonUrl = 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/' + select.value + '.geojson'
    addEarthquake(geojsonUrl, select.value==='default');
}

function addEarthquake(geojsonUrl, isDefault) {
    var heatLayerName = "earthquakes-heat";
    var pointLayerName = "earthquakes-point";
    var sourceName = 'earthquakes';

    var heatLayer = map.getLayer(heatLayerName);
    var pointLayer = map.getLayer(pointLayerName);
    var source = map.getSource(sourceName);
    if (heatLayer) map.removeLayer(heatLayerName);
    if (pointLayer) map.removeLayer(pointLayerName);
    if (source) map.removeSource(sourceName);

    if (isDefault) return;

    map.addSource(sourceName, {
        "type": "geojson",
        "data": geojsonUrl
    });

    map.addLayer({
        "id": heatLayerName,
        "type": "heatmap",
        "source": "earthquakes",
        "maxzoom": 9,
        "paint": {
            // Increase the heatmap weight based on frequency and property magnitude
            "heatmap-weight": [
                "interpolate",
                ["linear"],
                ["get", "mag"],
                0, 0,
                6, 1
            ],
            // Increase the heatmap color weight weight by zoom level
            // heatmap-intensity is a multiplier on top of heatmap-weight
            "heatmap-intensity": [
                "interpolate",
                ["linear"],
                ["zoom"],
                0, 1,
                9, 3
            ],
            // Color ramp for heatmap.  Domain is 0 (low) to 1 (high).
            // Begin color ramp at 0-stop with a 0-transparancy color
            // to create a blur-like effect.
            "heatmap-color": [
                "interpolate",
                ["linear"],
                ["heatmap-density"],
                0, "rgba(33,102,172,0)",
                0.2, "rgb(103,169,207)",
                0.4, "rgb(209,229,240)",
                0.6, "rgb(253,219,199)",
                0.8, "rgb(239,138,98)",
                1, "rgb(178,24,43)"
            ],
            // Adjust the heatmap radius by zoom level
            "heatmap-radius": [
                "interpolate",
                ["linear"],
                ["zoom"],
                0, 2,
                9, 20
            ],
            // Transition from heatmap to circle layer by zoom level
            "heatmap-opacity": [
                "interpolate",
                ["linear"],
                ["zoom"],
                7, 1,
                9, 0
            ],
        }
    }, '島BCD');

    map.addLayer({
        "id": pointLayerName,
        "type": "circle",
        "source": "earthquakes",
        "minzoom": 7,
        "paint": {
            // Size circle radius by earthquake magnitude and zoom level
            "circle-radius": [
                "interpolate",
                ["linear"],
                ["zoom"],
                7, [
                    "interpolate",
                    ["linear"],
                    ["get", "mag"],
                    1, 1,
                    6, 4
                ],
                16, [
                    "interpolate",
                    ["linear"],
                    ["get", "mag"],
                    1, 5,
                    6, 50
                ]
            ],
            // Color circle by earthquake magnitude
            "circle-color": [
                "interpolate",
                ["linear"],
                ["get", "mag"],
                1, "rgba(33,102,172,0)",
                2, "rgb(103,169,207)",
                3, "rgb(209,229,240)",
                4, "rgb(253,219,199)",
                5, "rgb(239,138,98)",
                6, "rgb(178,24,43)"
            ],
            "circle-stroke-color": "white",
            "circle-stroke-width": 1,
            // Transition from heatmap to circle layer by zoom level
            "circle-opacity": [
                "interpolate",
                ["linear"],
                ["zoom"],
                7, 0,
                8, 1
            ]
        }
    }, '島BCD');
}

function prepare() {
    
    var fonts = map.getLayoutProperty('島_群島_諸島_半島_岬', 'text-font');
    if (fonts.indexOf('Noto Sans Regular') >= 0 || fonts.indexOf('Noto Sans Bold') >= 0)
        return;

    addFont('島_群島_諸島_半島_岬', 'Noto Sans Regular');
    addFont('島_群島_諸島_半島_岬 国後島 択捉島 歯舞群島のみ', 'Noto Sans Regular');
    addFont('島_群島_諸島_半島_岬 色丹島のみ', 'Noto Sans Regular');
    addFont('middle_annotation 文字のみ', 'Noto Sans Regular');
    addFont('middle_annotation 国道番号', 'Noto Sans Regular');
    addFont('middle_annotation 文字とアイコン', 'Noto Sans Regular');
    addFont('middle_annotation 政令指定都市区役所', 'Noto Sans Regular');
    addFont('middle_annotation ランプ', 'Noto Sans Regular');
    addFont('middle_annotation ジャンクション', 'Noto Sans Regular');
    addFont('middle_annotation インターチェンジ', 'Noto Sans Regular');
    addFont('base_annotation 文字のみ', 'Noto Sans Regular');
    addFont('base_annotation 主要地方道番号', 'Noto Sans Regular');
    addFont('base_annotation 国道番号', 'Noto Sans Regular');
    addFont('base_annotation 文字とアイコン', 'Noto Sans Regular');
    addFont('base_annotation 政令指定都市区役所', 'Noto Sans Regular');
    addFont('主要交差点', 'Noto Sans Regular');
    addFont('base_annotation ランプ', 'Noto Sans Regular');
    addFont('base_annotation ジャンクション', 'Noto Sans Regular');
    addFont('base_annotation インターチェンジ', 'Noto Sans Regular');
    addFont('city_annotation 文字のみ', 'Noto Sans Regular');
    addFont('city_annotation 国道番号', 'Noto Sans Regular');
    addFont('city_annotation 文字とアイコン', 'Noto Sans Regular');
    addFont('city_annotation 政令指定都市区役所', 'Noto Sans Regular');
    addFont('city_annotation ランプ', 'Noto Sans Regular');
    addFont('city_annotation ジャンクション', 'Noto Sans Regular');
    addFont('中縮尺用インターチェンジ', 'Noto Sans Regular');
    addFont('中縮尺用インターチェンジ simple', 'Noto Sans Regular');
    addFont('city_annotation インターチェンジ', 'Noto Sans Regular');

    addFont('主要都市名', 'Noto Sans Bold');
    addFont('都道府県名', 'Noto Sans Bold');
    addFont('top_annotation 海', 'Noto Sans Bold');
    addFont('middle_annotation 海', 'Noto Sans Bold');
    addFont('middle_annotation 河川・沢・谷', 'Noto Sans Bold');
    addFont('middle_annotation 湖・池・沼', 'Noto Sans Bold');
    addFont('middle_annotation 湾・灘（海岸名）', 'Noto Sans Bold');
    addFont('middle_annotation 大字・町', 'Noto Sans Bold');
    addFont('middle_annotation 市区町村', 'Noto Sans Bold');
    addFont('middle_annotation 都道府県名', 'Noto Sans Bold');
    addFont('base_annotation 海', 'Noto Sans Bold');
    addFont('base_annotation 河川・沢・谷', 'Noto Sans Bold');
    addFont('base_annotation 湖・池・沼', 'Noto Sans Bold');
    addFont('base_annotation 湾・灘（海岸名）', 'Noto Sans Bold');
    addFont('base_annotation 丁目・字', 'Noto Sans Bold');
    addFont('base_annotation 条丁目', 'Noto Sans Bold');
    addFont('base_annotation 大字・町', 'Noto Sans Bold');
    addFont('base_annotation 市区町村', 'Noto Sans Bold');
    addFont('base_annotation 遊園地、総合リゾート、動物園、水族館、植物園、美術館、博物館・文学館・科学館・資料館', 'Noto Sans Bold');
    addFont('base_annotation テーマパーク', 'Noto Sans Bold');
    addFont('base_annotation 駅', 'Noto Sans Bold');
    addFont('city_annotation 海', 'Noto Sans Bold');
    addFont('city_annotation 河川・沢・谷', 'Noto Sans Bold');
    addFont('city_annotation 湖・池・沼', 'Noto Sans Bold');
    addFont('city_annotation 湾・灘（海岸名）', 'Noto Sans Bold');
    addFont('city_annotation 丁目・字', 'Noto Sans Bold');
    addFont('city_annotation 大字・町', 'Noto Sans Bold');
    addFont('city_annotation 遊園地、総合リゾート、動物園、水族館、植物園、美術館、博物館・文学館・科学館・資料館', 'Noto Sans Bold');
    addFont('city_annotation テーマパーク', 'Noto Sans Bold');
    addFont('city_annotation 駅', 'Noto Sans Bold');
}

function addFont(id, font) {
    var fonts = map.getLayoutProperty(id, 'text-font');
    fonts.push(font);
    map.setLayoutProperty(id, 'text-font', fonts);
}

function switchLanguage(select) {
    prepare();
    var langName = select.value.replace('lang', '');
    var textFieldId = '{' + 'name_string1' + langName + '}';

    map.setLayoutProperty('主要都市名', 'text-field', textFieldId);
    map.setLayoutProperty('島_群島_諸島_半島_岬', 'text-field', textFieldId);
    map.setLayoutProperty('島_群島_諸島_半島_岬 国後島 択捉島 歯舞群島のみ', 'text-field', textFieldId);
    map.setLayoutProperty('島_群島_諸島_半島_岬 色丹島のみ', 'text-field', textFieldId);
    map.setLayoutProperty('都道府県名', 'text-field', textFieldId);
    map.setLayoutProperty('top_annotation 海', 'text-field', textFieldId);
    map.setLayoutProperty('middle_annotation 文字のみ', 'text-field', textFieldId);
    map.setLayoutProperty('middle_annotation 海', 'text-field', textFieldId);
    map.setLayoutProperty('middle_annotation 河川・沢・谷', 'text-field', textFieldId);
    map.setLayoutProperty('middle_annotation 湖・池・沼', 'text-field', textFieldId);
    map.setLayoutProperty('middle_annotation 湾・灘（海岸名）', 'text-field', textFieldId);
    map.setLayoutProperty('middle_annotation 国道番号', 'text-field', textFieldId);
    map.setLayoutProperty('middle_annotation 大字・町', 'text-field', textFieldId);
    map.setLayoutProperty('middle_annotation 市区町村', 'text-field', textFieldId);
    map.setLayoutProperty('middle_annotation 文字とアイコン', 'text-field', textFieldId);
    map.setLayoutProperty('middle_annotation 政令指定都市区役所', 'text-field', textFieldId);
    map.setLayoutProperty('middle_annotation 都道府県名', 'text-field', textFieldId);
    map.setLayoutProperty('middle_annotation ランプ', 'text-field', textFieldId);
    map.setLayoutProperty('middle_annotation ジャンクション', 'text-field', textFieldId);
    map.setLayoutProperty('middle_annotation インターチェンジ', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation 文字のみ', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation 海', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation 河川・沢・谷', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation 湖・池・沼', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation 湾・灘（海岸名）', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation 主要地方道番号', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation 国道番号', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation 丁目・字', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation 条丁目', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation 大字・町', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation 市区町村', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation 文字とアイコン', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation 政令指定都市区役所', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation 遊園地、総合リゾート、動物園、水族館、植物園、美術館、博物館・文学館・科学館・資料館', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation テーマパーク', 'text-field', textFieldId);
    map.setLayoutProperty('主要交差点', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation ランプ', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation ジャンクション', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation インターチェンジ', 'text-field', textFieldId);
    map.setLayoutProperty('base_annotation 駅', 'text-field', textFieldId);
    map.setLayoutProperty('city_annotation 文字のみ', 'text-field', textFieldId);
    map.setLayoutProperty('city_annotation 海', 'text-field', textFieldId);
    map.setLayoutProperty('city_annotation 河川・沢・谷', 'text-field', textFieldId);
    map.setLayoutProperty('city_annotation 湖・池・沼', 'text-field', textFieldId);
    map.setLayoutProperty('city_annotation 湾・灘（海岸名）', 'text-field', textFieldId);
    map.setLayoutProperty('city_annotation 国道番号', 'text-field', textFieldId);
    map.setLayoutProperty('city_annotation 丁目・字', 'text-field', textFieldId);
    map.setLayoutProperty('city_annotation 大字・町', 'text-field', textFieldId);
    map.setLayoutProperty('city_annotation 文字とアイコン', 'text-field', textFieldId);
    map.setLayoutProperty('city_annotation 政令指定都市区役所', 'text-field', textFieldId);
    map.setLayoutProperty('city_annotation 遊園地、総合リゾート、動物園、水族館、植物園、美術館、博物館・文学館・科学館・資料館', 'text-field', textFieldId);
    map.setLayoutProperty('city_annotation テーマパーク', 'text-field', textFieldId);
    map.setLayoutProperty('city_annotation ランプ', 'text-field', textFieldId);
    map.setLayoutProperty('city_annotation ジャンクション', 'text-field', textFieldId);
    map.setLayoutProperty('中縮尺用インターチェンジ', 'text-field', textFieldId);
    map.setLayoutProperty('中縮尺用インターチェンジ simple', 'text-field', textFieldId);
    map.setLayoutProperty('city_annotation インターチェンジ', 'text-field', textFieldId);
    map.setLayoutProperty('city_annotation 駅', 'text-field', textFieldId);

    setIconImage('middle_annotation 国道番号', langName);
    setIconImage('middle_annotation ランプ', langName);
    setIconImage('middle_annotation ジャンクション', langName);
    setIconImage('middle_annotation インターチェンジ', langName);
    setIconImage('base_annotation 主要地方道番号', langName);
    setIconImage('base_annotation 国道番号', langName);
    setIconImage('主要交差点', langName);
    setIconImage('base_annotation ランプ', langName);
    setIconImage('base_annotation ジャンクション', langName);
    setIconImage('base_annotation インターチェンジ', langName);
    setIconImage('city_annotation 国道番号', langName);
    setIconImage('city_annotation ランプ', langName);
    setIconImage('city_annotation ジャンクション', langName);
    setIconImage('中縮尺用インターチェンジ', langName);
    setIconImage('中縮尺用インターチェンジ simple', langName);
    setIconImage('city_annotation インターチェンジ', langName);
}

function setIconImage(layerName, langName) {
    var iconImage = map.getLayoutProperty(layerName, 'icon-image');
    var lenIndexStart = iconImage.indexOf('{') + 1;
    var lenIndexEnd = iconImage.indexOf('}');
    var lenName = iconImage.substring(lenIndexStart, lenIndexEnd);
    var reIconImage = iconImage.replace(lenName, 'len' + langName);

    map.setLayoutProperty(layerName, 'icon-image', reIconImage);
}

var params = {};
parsePramameter(params);

var style = params.style ? params.style : 'lab'; // /mapion-vector/?style=base
// document.getElementById(style).checked = true;

var PRODUCT = document.domain === 'mapion.github.io' ? true : false;

var map; // for external use

var DEFAULT_CENTER = [139.749792, 35.641690];
var DEFAULT_ZOOM_LEVEL = 16;

if (!mapboxgl.supported()) {
    alert('Your browser does not support Mapion GL');
}

map = new mapboxgl.Map({
    container: 'map',
    center: DEFAULT_CENTER,
    zoom: DEFAULT_ZOOM_LEVEL,
    minZoom: 5,
    maxZoom: 19,
    style: getAbsolutePath(style),
    hash: true
});

map.addControl(new mapboxgl.NavigationControl());
map.addControl(new mapboxgl.GeolocateControl());
map.addControl(new mapboxgl.FullscreenControl());
map.addControl(new mapboxgl.ScaleControl(), 'bottom-right');

/*
% webmerc -o 5/25/15
5.615985,106.874999
% webmerc -o 5/30/10
52.48278,163.124999
*/

// map.setMaxBounds(new mapboxgl.LngLatBounds([106.874999, 5.615985], [163.124999, 52.48278]));
// map.showTileBoundaries = PRODUCT?false:true;

map.on('load', function() {

    map.on('click', function(e) {
        if (!kyorisokuMode) return;

        var features = map.queryRenderedFeatures(e.point, { layers: ['measure-points'] });

        if (distanceFeatures.features.length > 1) distanceFeatures.features.pop();

        if (features.length) {
            var id = features[0].properties.id;
            distanceFeatures.features = distanceFeatures.features.filter(function(point) {
                return point.properties.id !== id;
            });
            if (features.length <= 1) {
                if (distancePopup) {
                    distancePopup.remove();
                    distancePopup = null;
                }
            }
        } else {
            var point = {
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [
                        e.lngLat.lng,
                        e.lngLat.lat
                    ]
                },
                "properties": {
                    "id": String(new Date().getTime())
                }
            };

            distanceFeatures.features.push(point);
        }

        if (distanceFeatures.features.length > 1) {
            linestring.geometry.coordinates = distanceFeatures.features.map(function(point) {
                return point.geometry.coordinates;
            });

            distanceFeatures.features.push(linestring);

            var c = distanceFeatures.features[distanceFeatures.features.length-2].geometry.coordinates;
            if (distancePopup === null) {
                distancePopup = new mapboxgl.Popup({closeButton: false, closeOnClick: false}).addTo(map);
            }
            distancePopup.setLngLat(c).setHTML(Math.round(turf.lineDistance(linestring).toLocaleString() * 1000) / 1000 + 'km');
        }

        map.getSource('geojson').setData(distanceFeatures);

    });

    map.on('click', 'middle_annotation 文字とアイコン', function (e) {
        poiOnClick(e, e.features[0].properties.name_string1);
    });
    map.on('click', 'base_annotation 文字とアイコン', function (e) {
        poiOnClick(e, e.features[0].properties.name_string1);
    });
    map.on('click', 'city_annotation 文字とアイコン', function (e) {
        poiOnClick(e, e.features[0].properties.name_string1);
    });
    map.on('click', 'ロゴ', function (e) {
        poiOnClick(e, e.features[0].properties.poi_name);
    });
    map.on('click', 'ロゴ（名称）', function (e) {
        poiOnClick(e, e.features[0].properties.poi_name);
    });

    document.getElementById('init').addEventListener('click', function(e) {
        e.target.blur();
        map.flyTo({center: DEFAULT_CENTER, zoom: DEFAULT_ZOOM_LEVEL, bearing: 0, pitch: 0});
    });
});

map.on('mousemove', function (e) {
    if (kyorisokuMode) {
        var features = map.queryRenderedFeatures(e.point, { layers: ['measure-points'] });
        map.getCanvas().style.cursor = (features.length) ? 'default' : 'crosshair';
    } else {
        map.getCanvas().style.cursor = 'default';
    }
});

function poiOnClick(e, name) {
    if (!kyorisokuMode && name) {
        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(name)
            .addTo(map);
    }
}

var kyorisokuMode = false;
document.getElementById('kyorisoku_label').onclick = function(e) {
    e.target.checked ? initKyorisoku() : destroyKyorisoku();
    kyorisokuMode = e.target.checked;
};

var distancePopup = null;
var distanceFeatures;

var linestring = {
    "type": "Feature",
    "geometry": {
        "type": "LineString",
        "coordinates": []
    }
};

// GA
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', PRODUCT?'UA-29986121-1':'UA-82138036-1', 'auto');
ga('send', 'pageview');

</script>
</body>
</html>
